//
// Created by Y on 2020/9/28.
//
#include "FIR_Filter.h"

uint32_t blockSize = BLOCK_SIZE;
uint32_t numBlocks = LENGTH_SAMPLES/BLOCK_SIZE;             /* 需要调用arm_fir_f32的次数 */

static float32_t firStateF32[BLOCK_SIZE + NUM_TAPS - 1];    /* 状态缓存，大小numTaps + blockSize - 1*/

/*通过Matlab FilterDesign获取的滤波器系数*/
/* 低通滤波器系数 */
const float32_t firCoeffs32LP[NUM_TAPS] = {
        0.000186885547,0.0002926216985,0.0003312265908,0.0002900286054,0.0001726488117,
        -5.534653071e-19,-0.0001919005299,-0.0003577065654,-0.0004518038477,-0.0004393611744,
        -0.0003070674138,-7.06053761e-05,0.0002239977766,0.0005069766776,0.0006993321585,
        0.0007328189677,0.0005708308308,0.0002243524941,-0.0002425851708,-0.0007215006044,
        -0.001082197763,-0.001205605105,-0.001019021845,-0.0005240662722,0.0001918604248,
        0.0009664963,  0.00159640878, 0.001887368504, 0.001709654927, 0.001043427736,
        -2.267504925e-18, -0.00119032932,-0.002225095872,-0.002802807139,-0.002705618041,
        -0.001869928907,-0.0004238905385, 0.001322694588, 0.002939272206, 0.003975874744,
        0.00408222666, 0.003114413703, 0.001198733924,-0.001269547734,-0.003699821886,
        -0.005440736189,-0.005946743302,-0.004935772158,-0.002495056251,0.0008988176705,
        0.004460549448,  0.00726744486, 0.008486481383, 0.007603838574, 0.004597246647,
        -4.956351252e-18, -0.00517202029,-0.009626761079, -0.01209781785, -0.01167533919,
        -0.008085315116,-0.001841024263, 0.005785824731,  0.01298767701,  0.01780495234,
        0.01859632879,  0.01449266262, 0.005725614261,-0.006258855108, -0.01895038225,
        -0.02917989716, -0.03371524066, -0.02993351407, -0.01643189788, 0.006557176355,
        0.03704674169,  0.07151482254,   0.1054365039,   0.1340361387,   0.1531186253,
        0.1598184407,   0.1531186253,   0.1340361387,   0.1054365039,  0.07151482254,
        0.03704674169, 0.006557176355, -0.01643189788, -0.02993351407, -0.03371524066,
        -0.02917989716, -0.01895038225,-0.006258855108, 0.005725614261,  0.01449266262,
        0.01859632879,  0.01780495234,  0.01298767701, 0.005785824731,-0.001841024263,
        -0.008085315116, -0.01167533919, -0.01209781785,-0.009626761079, -0.00517202029,
        -4.956351252e-18, 0.004597246647, 0.007603838574, 0.008486481383,  0.00726744486,
        0.004460549448,0.0008988176705,-0.002495056251,-0.004935772158,-0.005946743302,
        -0.005440736189,-0.003699821886,-0.001269547734, 0.001198733924, 0.003114413703,
        0.00408222666, 0.003975874744, 0.002939272206, 0.001322694588,-0.0004238905385,
        -0.001869928907,-0.002705618041,-0.002802807139,-0.002225095872, -0.00119032932,
        -2.267504925e-18, 0.001043427736, 0.001709654927, 0.001887368504,  0.00159640878,
        0.0009664963,0.0001918604248,-0.0005240662722,-0.001019021845,-0.001205605105,
        -0.001082197763,-0.0007215006044,-0.0002425851708,0.0002243524941,0.0005708308308,
        0.0007328189677,0.0006993321585,0.0005069766776,0.0002239977766,-7.06053761e-05,
        -0.0003070674138,-0.0004393611744,-0.0004518038477,-0.0003577065654,-0.0001919005299,
        -5.534653071e-19,0.0001726488117,0.0002900286054,0.0003312265908,0.0002926216985,
        0.000186885547
};

arm_fir_instance_f32 S;

/**
 * @brief    FIR滤波器配置初始化
 * @param    none
 * @retval   none
*/
void arm_fir_f32_init(void)
{
    /* 低通滤波器配置 */
    arm_fir_init_f32(&S, NUM_TAPS, (float32_t *)&firCoeffs32LP[0], &firStateF32[0], blockSize);
}

/**
 * @brief    调用函数arm_fir_f32_lp实现低通滤波器
 * @param    Input_f32 : 输入数据
 * @param    Output_f32 : 输出数据
 * @retval   none
*/
void arm_fir_f32_lp(float32_t *Input_f32, float32_t *Output_f32)
{
    /* 实现FIR滤波 */
    for(int i=0; i < numBlocks; i++)
    {
        arm_fir_f32(&S, Input_f32 + (i * blockSize), Output_f32 + (i * blockSize), blockSize);
    }

//    /* 打印滤波后结果 */
//    for(int i=0; i<LENGTH_SAMPLES; i++)
//    {
//        printf("%f\r\n", Output_f32[i]);
//    }
}

